name: Panel Omega - Unit Test & Build
on: [push]
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  panel-omega-e2e-test:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2
        with:
          repository: ${{ github.repository }}
          ref: ${{ github.sha }}
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: oci8
        env:
          fail-fast: true

      - name: Create Server & Run E2E Test
        run: |
          GITHUB_COMMIT_SHA=${{ github.sha }}
          GITHUB_REPOSITORY=${{ github.repository }}
          cd e2e-test
          sudo wget https://getcomposer.org/download/latest-stable/composer.phar
          sudo COMPOSER_ALLOW_SUPERUSER=1 php composer.phar install
          sudo HETZNER_API_KEY=${{ secrets.HETZNER_API_KEY }} php create-hetzner-server.php
#
#  panel-omega-unit-test:
#    strategy:
#      matrix:
#        os: [ubuntu-22.04, ubuntu-20.04]
#
#    runs-on: ${{ matrix.os }}
#
#    steps:
#      - name: Checkout Repository
#        uses: actions/checkout@v2
#        with:
#          repository: ${{ github.repository }}
#          ref: ${{ github.sha }}
#
#      - name: Install Base
#        run: |
#          ls -la
#          sudo mkdir /panel-omega
#
#          sudo cp installers/${{ matrix.os }}/install-partial/install_base.sh /panel-omega/install_base.sh
#          sudo chmod +x /panel-omega/install_base.sh
#          sudo /panel-omega/install_base.sh
#
#          sudo cp installers/ubuntu-20.04/install-partial/install_web.sh /panel-omega/install_web.sh
#          sudo chmod +x /panel-omega/install_web.sh
#
#      - name: Run Unit Test
#        run: |
#
#          sudo cp -r web /usr/local/omega/web/
#          cd /usr/local/omega/web/
#          ls -la
#
#          sudo wget https://getcomposer.org/download/latest-stable/composer.phar
#          sudo COMPOSER_ALLOW_SUPERUSER=1 omega-php composer.phar install
#
#          sudo /panel-omega/install_web.sh
#          sudo omega-php artisan test --filter DomainTest
#
#  compile-panel-omega-web:
#    runs-on: ubuntu-22.04
#    needs: panel-omega-unit-test
#    steps:
#      - uses: actions/checkout@v2
#        with:
#          repository: ${{ github.repository }}
#      - name: Npm install
#        uses: actions/setup-node@v3
#        with:
#          node-version: 16
#
#      - name: Setup PHP
#        uses: shivammathur/setup-php@v2
#        with:
#          php-version: 8.2
#
#      - name: Install Composer Dependencies
#        working-directory: ./web
#        run: |
#          composer install
#          composer dump-autoload
#
#      - name: Install NODE Dependencies
#        working-directory: ./web
#        run: |
#          npm install
#          npm run build
#
#      - name: Inject slug/short variables
#        uses: rlespinasse/github-slug-action@v3.x
#
#      - name: Zip the files
#        working-directory: ./web
#        run: |
#          rm -rf .git
#          rm -rf .github
#          rm -rf .nmp
#          rm -rf node_modules
#          rm -rf .phpunit.cache
#          rm -rf vendor/composer/tmp-*.zip
#          find . \( -name ".git" -o -name ".gitignore" -o -name ".gitmodules" -o -name ".gitattributes"  \) -exec rm -rf -- {} +
#          zip -r panel-omega-web-build.zip `ls -A`
#          mkdir -p ../dist
#          mv ./panel-omega-web-build.zip ../dist/panel-omega-latest.zip
#
#      - name: Pushes to PanelOmega WebCompiledVersions
#        uses: cpina/github-action-push-to-another-repository@main
#        env:
#          SSH_DEPLOY_KEY: ${{ secrets.SSH_DEPLOY_KEY }}
#        with:
#          source-directory: './dist'
#          destination-github-username: 'PanelOmega'
#          destination-repository-name: 'WebCompiledVersions'
#          user-email: bobicloudvision@gmail.com
#          target-branch: main
